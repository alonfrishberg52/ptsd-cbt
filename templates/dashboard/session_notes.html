z{% extends "dashboard/base_enhanced.html" %}

{% block title %}רשומות טיפול - NarraTIVE{% endblock %}
{% block page_title %}רשומות טיפול{% endblock %}
{% block page_description %}ניהול והוספת רשומות טיפוליות מתקדמות{% endblock %}

{% block content %}
<!-- Modern Dashboard Content -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">רשומות טיפול</h3>
            <p style="margin: var(--space-xs) 0 0; color: var(--text-secondary);">ניהול והוספת רשומות טיפוליות מתקדמות</p>
        </div>
        <i class="bi bi-journal-text" style="color: var(--primary-color); font-size: 2rem;"></i>
    </div>

    <div class="card-body" style="padding: var(--space-xl);">
    <!-- Modern Tabs Container -->
    <div class="modern-tabs-container">
            <ul class="nav nav-pills nav-fill modern-nav-tabs" id="mainTab" role="tablist" style="background: var(--bg-subtle); border-radius: var(--radius-lg); padding: var(--space-xs); margin-bottom: var(--space-xl);">
                <li class="nav-item" role="presentation" style="flex: 1;">
                    <button class="nav-link active modern-tab-link" id="add-note-tab" data-bs-toggle="tab" data-bs-target="#add-note" type="button" role="tab" style="width: 100%; border-radius: var(--radius-md); padding: var(--space-md); transition: all var(--transition-fast); background: var(--primary-color); color: white; border: none;">
                        <i class="bi bi-plus-circle" style="margin-left: var(--space-sm);"></i>
                    הוספת רשומה
                </button>
            </li>
                <li class="nav-item" role="presentation" style="flex: 1;">
                    <button class="nav-link modern-tab-link" id="view-notes-tab" data-bs-toggle="tab" data-bs-target="#view-notes" type="button" role="tab" style="width: 100%; border-radius: var(--radius-md); padding: var(--space-md); transition: all var(--transition-fast); background: transparent; color: var(--text-secondary); border: none;">
                        <i class="bi bi-list-ul" style="margin-left: var(--space-sm);"></i>
                    צפייה ברשומות
                </button>
            </li>
        </ul>

        <div class="tab-content modern-tab-content" id="mainTabContent">
            <!-- Add Note Tab -->
            <div class="tab-pane fade show active" id="add-note" role="tabpanel">
                <div class="modern-card">
                        <div class="modern-card-body">
                            <div id="saveAlert" class="modern-alert alert-success" style="display: none; padding: var(--space-md); background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <i class="bi bi-check-circle-fill" style="color: var(--success-color);"></i>
                                    <span id="saveAlertText" style="color: var(--success-color); font-weight: 500;"></span>
                    </div>
                        </div>

                        <!-- Patient and Session Selection -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-xl);">
                                <div>
                                    <label for="patientSelect" class="form-label" style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-sm);">בחירת מטופל</label>
                                    <select class="form-select" id="patientSelect" style="border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); padding: var(--space-md); transition: all var(--transition-fast);">
                                    <option value="">בחר מטופל...</option>
                                </select>
                            </div>

                                <div>
                                    <label for="sessionSelect" class="form-label" style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-sm);">בחירת פגישה</label>
                                    <select class="form-select" id="sessionSelect" disabled style="border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); padding: var(--space-md); transition: all var(--transition-fast);">
                                    <option value="">בחר מטופל תחילה</option>
                                </select>
                            </div>
                        </div>

                        <!-- New Session Fields -->
                            <div id="newSessionFields" style="display: none; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-xl);">
                                <div>
                                    <label for="sessionDateTime" class="form-label" style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-sm);">תאריך ושעת הפגישה</label>
                                    <input type="datetime-local" class="form-control" id="sessionDateTime" style="border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); padding: var(--space-md); transition: all var(--transition-fast);">
                            </div>

                                <div>
                                    <label for="sessionLevel" class="form-label" style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-sm);">רמת הפגישה</label>
                                    <select class="form-select" id="sessionLevel" style="border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); padding: var(--space-md); transition: all var(--transition-fast);">
                                    <option value="">בחר רמה...</option>
                                    <option value="מתחיל">מתחיל</option>
                                    <option value="בינוני">בינוני</option>
                                    <option value="מתקדם">מתקדם</option>
                                </select>
                            </div>
                        </div>

                        <!-- Rich Text Editor -->
                            <div style="margin-bottom: var(--space-xl);">
                                <label for="noteContent" class="form-label" style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-sm);">רשומות הפגישה</label>
                                
                                <div class="modern-editor-toolbar" style="background: var(--bg-subtle); border-radius: var(--radius-md) var(--radius-md) 0 0; padding: var(--space-md); border: 1px solid rgba(0, 0, 0, 0.1); border-bottom: none; display: flex; gap: var(--space-md); align-items: center; flex-wrap: wrap;">
                                    <div class="toolbar-group" style="display: flex; gap: var(--space-xs);">
                                        <button type="button" class="btn btn-ghost btn-sm" onclick="formatText('bold')" title="מודגש" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                        <button type="button" class="btn btn-ghost btn-sm" onclick="formatText('italic')" title="נטוי" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                        <button type="button" class="btn btn-ghost btn-sm" onclick="formatText('underline')" title="קו תחתון" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                </div>
                                
                                    <div class="toolbar-separator" style="width: 1px; height: 24px; background: rgba(0, 0, 0, 0.1);"></div>
                                
                                    <div class="toolbar-group" style="display: flex; gap: var(--space-xs);">
                                        <button type="button" class="btn btn-outline btn-sm" onclick="insertTemplate('assessment')" style="padding: var(--space-xs) var(--space-sm);">
                                        תבנית הערכה
                                    </button>
                                        <button type="button" class="btn btn-outline btn-sm" onclick="insertTemplate('progress')" style="padding: var(--space-xs) var(--space-sm);">
                                        תבנית התקדמות
                                    </button>
                                        <button type="button" class="btn btn-outline btn-sm" onclick="insertTemplate('homework')" style="padding: var(--space-xs) var(--space-sm);">
                                        תבנית תרגילים
                                    </button>
                                </div>
                            </div>
                            
                                <div id="richTextEditor" contenteditable="true" class="modern-rich-editor" placeholder="הזן את רשומות הפגישה כאן..." style="min-height: 300px; padding: var(--space-lg); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0 0 var(--radius-md) var(--radius-md); background: white; font-size: 1rem; line-height: 1.6; outline: none; transition: border-color var(--transition-fast);">
                                </div>
                        </div>

                        <!-- Statistics -->
                            <div class="modern-stats-container" style="background: var(--bg-subtle); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-xl);">
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-lg); text-align: center;">
                                    <div class="stat-item">
                                        <span class="stat-number" id="wordCount" style="display: block; font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">0</span>
                                        <span class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);">מילים</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="charCount" style="display: block; font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">0</span>
                                        <span class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);">תווים</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="charNoSpaceCount" style="display: block; font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">0</span>
                                        <span class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);">ללא רווחים</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="paragraphCount" style="display: block; font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">0</span>
                                        <span class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);">פסקאות</span>
                                </div>
                            </div>
                        </div>

                            <div style="display: flex; gap: var(--space-md); justify-content: flex-end;">
                                <button class="btn btn-outline" id="clearNotesBtn" style="padding: var(--space-md) var(--space-lg);">
                                    <i class="bi bi-x-circle" style="margin-left: var(--space-sm);"></i>
                                נקה
                            </button>
                                <button class="btn btn-primary" id="saveNotesBtn" disabled style="padding: var(--space-md) var(--space-lg);">
                                    <i class="bi bi-save" style="margin-left: var(--space-sm);"></i>
                                שמור רשומה
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Notes Tab -->
            <div class="tab-pane fade" id="view-notes" role="tabpanel">
                <div class="modern-card">
                    <div class="modern-card-body">
                        <!-- Modern Filters -->
                            <div class="modern-filters-container" style="background: var(--bg-subtle); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-xl);">
                                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: var(--space-md);">
                                    <div class="search-input-container" style="position: relative;">
                                        <i class="bi bi-search" style="position: absolute; right: var(--space-md); top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                                        <input type="text" class="form-control" id="searchNotes" placeholder="חיפוש ברשומות..." style="padding-right: 3rem; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1);">
                                    </div>
                                    <div>
                                        <select class="form-select" id="filterPatient" style="border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1);">
                                        <option value="">כל המטופלים</option>
                                    </select>
                                </div>
                                    <div>
                                        <select class="form-select" id="filterLevel" style="border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1);">
                                        <option value="">כל הרמות</option>
                                        <option value="מתחיל">מתחיל</option>
                                        <option value="בינוני">בינוני</option>
                                        <option value="מתקדם">מתקדם</option>
                                    </select>
                                </div>
                                    <div>
                                        <button class="btn btn-outline w-100" id="resetFilters" style="border-radius: var(--radius-md);">
                                            <i class="bi bi-arrow-clockwise" style="margin-left: var(--space-sm);"></i>
                                        איפוס
                                    </button>
                                </div>
                            </div>
                        </div>

                            <!-- Notes List -->
                            <div id="notesList" style="display: grid; gap: var(--space-lg);">
                                <div class="empty-state" style="text-align: center; padding: var(--space-2xl); color: var(--text-muted);">
                                    <i class="bi bi-journal-x" style="font-size: 4rem; margin-bottom: var(--space-lg);"></i>
                                    <div style="font-size: 1.25rem; margin-bottom: var(--space-sm);">אין רשומות זמינות</div>
                                    <div style="font-size: 1rem;">הוסף רשומה ראשונה כדי להתחיל</div>
                        </div>
                                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/dashboard/js/session_notes_enhanced.js"></script>

<script>
// Modern session notes functionality
document.addEventListener('DOMContentLoaded', function() {
    loadPatients();
    loadExistingNotes();
    initializeEditor();
    bindEventListeners();
    updateTabStyles();
});

function updateTabStyles() {
    // Handle tab switching styles
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            // Reset all tabs
            document.querySelectorAll('.modern-tab-link').forEach(t => {
                t.style.background = 'transparent';
                t.style.color = 'var(--text-secondary)';
            });
            
            // Style active tab
            e.target.style.background = 'var(--primary-color)';
            e.target.style.color = 'white';
        });
    });
}

async function loadPatients() {
    try {
        const response = await fetch('/api/patients');
        const data = await response.json();
        
        if (data.status === 'success') {
            const patientSelect = document.getElementById('patientSelect');
            const filterPatient = document.getElementById('filterPatient');
            
            patientSelect.innerHTML = '<option value="">בחר מטופל...</option>';
            filterPatient.innerHTML = '<option value="">כל המטופלים</option>';
            
            data.patients.forEach(patient => {
                const option1 = new Option(patient.name || `${patient.first_name || ''} ${patient.last_name || ''}`.trim(), patient.patient_id);
                const option2 = new Option(patient.name || `${patient.first_name || ''} ${patient.last_name || ''}`.trim(), patient.patient_id);
                
                patientSelect.appendChild(option1);
                filterPatient.appendChild(option2);
            });
        }
    } catch (error) {
        console.error('Error loading patients:', error);
        showAlert('שגיאה בטעינת רשימת המטופלים', 'error');
    }
}

async function loadExistingNotes() {
    try {
        const response = await fetch('/api/session-notes/list/all');
        const data = await response.json();
        
        if (data.status === 'success') {
            displayNotes(data.notes);
        }
    } catch (error) {
        console.error('Error loading notes:', error);
    }
}

function displayNotes(notes) {
    const notesList = document.getElementById('notesList');
    
    if (!notes || notes.length === 0) {
        notesList.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: var(--space-2xl); color: var(--text-muted);">
                <i class="bi bi-journal-x" style="font-size: 4rem; margin-bottom: var(--space-lg);"></i>
                <div style="font-size: 1.25rem; margin-bottom: var(--space-sm);">אין רשומות זמינות</div>
                <div style="font-size: 1rem;">הוסף רשומה ראשונה כדי להתחיל</div>
            </div>
        `;
        return;
    }
    
    notesList.innerHTML = notes.map(note => `
        <div class="card note-card" style="transition: all var(--transition-fast); cursor: pointer;" onclick="viewNote('${note.id}')">
            <div class="card-body" style="padding: var(--space-lg);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-md);">
                    <div>
                        <h6 style="margin: 0; font-weight: 600; color: var(--text-primary);">${note.patient_name || note.patient_id}</h6>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: var(--space-xs);">
                            ${new Date(note.session_date).toLocaleDateString('he-IL')} • ${note.session_level || 'לא צוין'}
                        </div>
                    </div>
                    <span class="badge badge-primary">${note.session_type || 'כללי'}</span>
                </div>
                
                <div class="note-preview" style="color: var(--text-secondary); line-height: 1.5; margin-bottom: var(--space-md);">
                    ${(note.content || '').substring(0, 150)}${(note.content || '').length > 150 ? '...' : ''}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-muted);">
                    <span>נוצר: ${new Date(note.created_at).toLocaleDateString('he-IL')}</span>
                    <span>${note.word_count || 0} מילים</span>
                </div>
            </div>
        </div>
    `).join('');
    
    // Add hover effects
    document.querySelectorAll('.note-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
            this.style.boxShadow = 'var(--shadow-xl)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'var(--shadow-sm)';
        });
    });
}

function initializeEditor() {
    const editor = document.getElementById('richTextEditor');
    
    editor.addEventListener('input', function() {
        updateWordCount();
        checkSaveButton();
    });
    
    editor.addEventListener('focus', function() {
        this.style.borderColor = 'var(--primary-color)';
        this.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.1)';
    });
    
    editor.addEventListener('blur', function() {
        this.style.borderColor = 'rgba(0, 0, 0, 0.1)';
        this.style.boxShadow = 'none';
    });
}

function updateWordCount() {
    const editor = document.getElementById('richTextEditor');
    const text = editor.textContent || editor.innerText || '';
    
    const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
    const charCount = text.length;
    const charNoSpaceCount = text.replace(/\s/g, '').length;
    const paragraphCount = text.trim() ? text.split(/\n\s*\n/).length : 0;
    
    document.getElementById('wordCount').textContent = wordCount;
    document.getElementById('charCount').textContent = charCount;
    document.getElementById('charNoSpaceCount').textContent = charNoSpaceCount;
    document.getElementById('paragraphCount').textContent = paragraphCount;
}

function checkSaveButton() {
    const patientSelect = document.getElementById('patientSelect');
    const editor = document.getElementById('richTextEditor');
    const saveBtn = document.getElementById('saveNotesBtn');
    
    const hasPatient = patientSelect.value !== '';
    const hasContent = (editor.textContent || editor.innerText || '').trim() !== '';
    
    saveBtn.disabled = !(hasPatient && hasContent);
}

function bindEventListeners() {
    // Patient selection
    document.getElementById('patientSelect').addEventListener('change', function() {
        const sessionSelect = document.getElementById('sessionSelect');
        if (this.value) {
            sessionSelect.disabled = false;
            sessionSelect.innerHTML = '<option value="new-session">+ פגישה חדשה</option>';
            loadPatientSessions(this.value);
        } else {
            sessionSelect.disabled = true;
            sessionSelect.innerHTML = '<option value="">בחר מטופל תחילה</option>';
        }
        checkSaveButton();
    });
    
    // Session selection
    document.getElementById('sessionSelect').addEventListener('change', function() {
        const newSessionFields = document.getElementById('newSessionFields');
        if (this.value === 'new-session') {
            newSessionFields.style.display = 'grid';
        } else {
            newSessionFields.style.display = 'none';
        }
    });
    
    // Save button
    document.getElementById('saveNotesBtn').addEventListener('click', saveNotes);
    
    // Clear button
    document.getElementById('clearNotesBtn').addEventListener('click', function() {
        if (confirm('האם אתה בטוח שברצונך לנקות את כל התוכן?')) {
            document.getElementById('richTextEditor').innerHTML = '';
            updateWordCount();
            checkSaveButton();
        }
    });
    
    // Search and filters
    document.getElementById('searchNotes').addEventListener('input', filterNotes);
    document.getElementById('filterPatient').addEventListener('change', filterNotes);
    document.getElementById('filterLevel').addEventListener('change', filterNotes);
    document.getElementById('resetFilters').addEventListener('click', resetFilters);
}

async function saveNotes() {
    const saveBtn = document.getElementById('saveNotesBtn');
    const originalText = saveBtn.innerHTML;
    
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-arrow-clockwise rotate"></i> שומר...';
        
        const noteData = {
            patient_id: document.getElementById('patientSelect').value,
            session_id: document.getElementById('sessionSelect').value === 'new-session' ? null : document.getElementById('sessionSelect').value,
            content: document.getElementById('richTextEditor').innerHTML,
            session_date: document.getElementById('sessionDateTime').value || new Date().toISOString(),
            session_level: document.getElementById('sessionLevel').value,
            word_count: parseInt(document.getElementById('wordCount').textContent)
        };
        
        const response = await fetch('/api/session-notes/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(noteData)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('הרשומה נשמרה בהצלחה!', 'success');
            document.getElementById('richTextEditor').innerHTML = '';
            updateWordCount();
            loadExistingNotes();
        } else {
            throw new Error(data.message || 'שגיאה בשמירה');
        }
    } catch (error) {
        console.error('Error saving notes:', error);
        showAlert('שגיאה בשמירת הרשומה', 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        checkSaveButton();
    }
}

function showAlert(message, type = 'success') {
    const alert = document.getElementById('saveAlert');
    const alertText = document.getElementById('saveAlertText');
    
    alertText.textContent = message;
    alert.className = `modern-alert alert-${type}`;
    alert.style.display = 'block';
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        alert.style.display = 'none';
    }, 3000);
}

function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('richTextEditor').focus();
}

function insertTemplate(templateType) {
    const templates = {
        assessment: `
            <h4>הערכת מצב</h4>
            <p><strong>מצב רוח כללי:</strong> </p>
            <p><strong>רמת SUD:</strong> </p>
            <p><strong>נושאים עיקריים:</strong> </p>
            <p><strong>התקדמות מהמפגש הקודם:</strong> </p>
        `,
        progress: `
            <h4>התקדמות טיפולית</h4>
            <p><strong>יעדים שהושגו:</strong> </p>
            <p><strong>אתגרים:</strong> </p>
            <p><strong>כישורי התמודדות חדשים:</strong> </p>
            <p><strong>תוכנית המשך:</strong> </p>
        `,
        homework: `
            <h4>תרגילים ומשימות</h4>
            <p><strong>תרגילים לבית:</strong> </p>
            <p><strong>טכניקות לתרגול:</strong> </p>
            <p><strong>מועד ביקורת:</strong> </p>
            <p><strong>הערות נוספות:</strong> </p>
        `
    };
    
    const editor = document.getElementById('richTextEditor');
    const template = templates[templateType] || '';
    
    editor.innerHTML += template;
    editor.focus();
    updateWordCount();
}

// Add enhanced styles
const enhancedStyles = `
    .rotate {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .modern-rich-editor:focus {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
    }
    
    .form-select:focus,
    .form-control:focus {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
    }
    
    @media (max-width: 768px) {
        .modern-nav-tabs {
            flex-direction: column !important;
        }
        
        .modern-nav-tabs .nav-item {
            margin-bottom: var(--space-xs);
        }
        
        .modern-filters-container > div {
            grid-template-columns: 1fr !important;
            gap: var(--space-sm) !important;
        }
        
        .modern-stats-container > div {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = enhancedStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %} 