{% extends 'dashboard/base_enhanced.html' %}

{% block title %}סקירת התקדמות מטופלים - NarraTIVE{% endblock %}
{% block page_title %}סקירת התקדמות מטופלים{% endblock %}
{% block page_description %}מעקב אחר התקדמות, מגמות והערות טיפוליות{% endblock %}

{% block content %}
<!-- Modern Dashboard Content -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">סקירת התקדמות מטופלים</h3>
            <p style="margin: var(--space-xs) 0 0; color: var(--text-secondary);">מעקב אחר התקדמות, מגמות והערות טיפוליות</p>
        </div>
        <i class="bi bi-graph-up-arrow" style="color: var(--primary-color); font-size: 2rem;"></i>
    </div>
    
    <div class="card-body" style="padding: var(--space-xl);">
        <!-- Alerts Section -->
        <div id="alerts-section" style="margin-bottom: var(--space-lg);"></div>
        
        <!-- Filter Buttons -->
        <div style="margin-bottom: var(--space-xl);">
            <div class="btn-group" role="group" aria-label="Filters">
                <button type="button" class="btn btn-primary active" id="filter-all">הכל</button>
                <button type="button" class="btn btn-outline-warning" id="filter-flagged">נדרש מעקב</button>
                <button type="button" class="btn btn-outline-secondary" id="filter-norecent">ללא מפגש לאחרונה</button>
                <button type="button" class="btn btn-outline-danger" id="filter-highsud">מגמת SUD גבוהה</button>
            </div>
        </div>
        
        <!-- Patient Grid -->
        <div id="patient-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: var(--space-lg);"></div>
        
        <!-- Empty State -->
        <div id="empty-state" class="empty-state" style="display:none; text-align: center; padding: var(--space-2xl); color: var(--text-muted);">
            <i class="bi bi-people" style="font-size: 4rem; margin-bottom: var(--space-lg);"></i>
            <div style="font-size: 1.25rem; margin-bottom: var(--space-sm);">אין מטופלים להצגה</div>
            <div style="font-size: 1rem;">הוסף מטופל חדש כדי להתחיל לעקוב אחרי התקדמות.</div>
            <button class="btn btn-primary" data-modal="add-patient" style="margin-top: var(--space-lg);">
                <i class="bi bi-plus"></i>
                הוסף מטופל
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="overview-toast" style="display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--primary-color);color:#fff;padding:1rem 2.5rem;border-radius:18px;font-size:1.2rem;box-shadow:0 4px 24px rgba(37, 99, 235, 0.2);z-index:9999;"></div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allPatients = [];
let currentFilter = 'all';
let lastOverviewData = null;

function initials(name) {
    if (!name) return '';
    return name.split(' ').map(w => w[0]).join('').toUpperCase();
}

function formatDate(dateStr) {
    if (!dateStr) return 'אין מפגשים';
    const d = new Date(dateStr);
    return d.toLocaleDateString('he-IL');
}

function renderAlerts(patients) {
    const alerts = [];
    
    // Flagged patients
    const flagged = patients.filter(p => p.flagged);
    if (flagged.length) {
        alerts.push(`
            <div class="alert alert-warning" style="border-radius: var(--radius-lg); border: none; background: rgba(251, 191, 36, 0.1); color: var(--warning-color); border-left: 4px solid var(--warning-color);">
                <i class="bi bi-flag-fill" style="margin-left: var(--space-sm);"></i>
                נדרש מעקב עבור: ${flagged.map(p => `<a href="/dashboard/patients/${p.patient_id}" style="font-weight: 700; color: var(--warning-color); text-decoration: underline;">${p.name}</a>`).join(', ')}
            </div>
        `);
    }
    
    // No recent session (>14 days)
    const norecent = patients.filter(p => p.last_session_days_ago !== null && p.last_session_days_ago > 14);
    if (norecent.length) {
        alerts.push(`
            <div class="alert alert-info" style="border-radius: var(--radius-lg); border: none; background: rgba(59, 130, 246, 0.1); color: var(--primary-color); border-left: 4px solid var(--primary-color);">
                <i class="bi bi-calendar-x" style="margin-left: var(--space-sm);"></i>
                לא התקיים מפגש ב-14 הימים האחרונים עבור: ${norecent.map(p => `<a href="/dashboard/patients/${p.patient_id}" style="font-weight: 700; color: var(--primary-color); text-decoration: underline;">${p.name}</a>`).join(', ')}
            </div>
        `);
    }
    
    // High SUD trend
    const highsud = patients.filter(p => p.high_sud_trend);
    if (highsud.length) {
        alerts.push(`
            <div class="alert alert-danger" style="border-radius: var(--radius-lg); border: none; background: rgba(239, 68, 68, 0.1); color: var(--danger-color); border-left: 4px solid var(--danger-color);">
                <i class="bi bi-thermometer-high" style="margin-left: var(--space-sm);"></i>
                מגמת SUD גבוהה עבור: ${highsud.map(p => `<a href="/dashboard/patients/${p.patient_id}" style="font-weight: 700; color: var(--danger-color); text-decoration: underline;">${p.name}</a>`).join(', ')}
            </div>
        `);
    }
    
    document.getElementById('alerts-section').innerHTML = alerts.join('');
}

function renderGrid(patients) {
    const grid = document.getElementById('patient-grid');
    const emptyState = document.getElementById('empty-state');
    
    grid.innerHTML = '';
    
    if (!patients.length) {
        emptyState.style.display = 'block';
        return;
    } else {
        emptyState.style.display = 'none';
    }
    
    patients.forEach((p, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.cssText = `
            transition: all var(--transition-normal);
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
        `;
        
        // Avatar
        let avatarHtml = '';
        if (p.avatar_url) {
            avatarHtml = `<img src="${p.avatar_url}" style="width:48px;height:48px;border-radius:50%;" alt="Avatar">`;
        } else {
            avatarHtml = `
                <div style="width:48px;height:48px;border-radius:50%;background:var(--primary-color);display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:600;color:white;">
                    ${initials(p.name)}
                </div>
            `;
        }
        
        // Status badges
        let flagHtml = p.flagged ? `<span class="badge badge-warning" style="margin-right: var(--space-xs);"><i class="bi bi-flag-fill"></i> נדרש מעקב</span>` : '';
        let noSessionsHtml = (!p.sud_trend || p.sud_trend.filter(x=>x!==null).length === 0) ? `<span class="badge badge-warning" style="margin-right: var(--space-xs);"><i class="bi bi-exclamation-circle"></i> אין מפגשים</span>` : '';
        
        // Latest note
        let noteHtml = '';
        if (p.latest_note) {
            noteHtml = `
                <div style="margin-top: var(--space-md); margin-bottom: var(--space-sm);">
                    <span style="font-weight: 600; color: var(--text-secondary);"><i class="bi bi-journal-text"></i> הערה אחרונה:</span>
                    <div style="margin-top: var(--space-xs); font-size: 0.9rem; color: var(--text-secondary); word-break: break-word;" title="${p.latest_note}">${p.latest_note.length > 100 ? p.latest_note.substring(0, 100) + '...' : p.latest_note}</div>
                </div>
            `;
            if (p.notes_count > 1) {
                noteHtml += `<a href="/dashboard/patients/${p.patient_id}" class="btn btn-ghost btn-sm" style="padding: var(--space-xs) var(--space-sm);">הצג כל ההערות (${p.notes_count})</a>`;
            }
        } else {
            noteHtml = `<div style="margin-top: var(--space-md); font-size: 0.9rem; color: var(--text-muted);"><i class="bi bi-journal-x"></i> אין הערות טיפוליות</div>`;
        }
        
        // Card content
        card.innerHTML = `
            <div class="card-body">
                <div style="display: flex; align-items: center; margin-bottom: var(--space-md);">
                    ${avatarHtml}
                    <div style="margin-right: var(--space-md); flex: 1;">
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: var(--space-xs);">
                            ${p.name} ${flagHtml} ${noSessionsHtml}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            מפגש אחרון: ${formatDate(p.last_session_date)}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: var(--space-md);">
                    <canvas id="sud-chart-${idx}" style="max-height: 100px;"></canvas>
                </div>
                
                <div style="margin-bottom: var(--space-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">התקדמות</span>
                        <span style="font-size: 0.9rem; font-weight: 600;">${p.progress}%</span>
                    </div>
                    <div style="height: 8px; background: rgba(0, 0, 0, 0.1); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${p.progress}%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--success-color)); transition: width var(--transition-normal);"></div>
                    </div>
                </div>
                
                ${noteHtml}
                
                <div style="display: flex; gap: var(--space-sm); margin-top: var(--space-lg);">
                    <a href="/dashboard/patients/${p.patient_id}" class="btn btn-outline flex-fill">
                        <i class="bi bi-person-lines-fill"></i>
                        פרופיל
                    </a>
                    <button class="btn btn-primary flex-fill">
                        <i class="bi bi-chat-dots"></i>
                        הודעה
                    </button>
                </div>
            </div>
        `;
        
        // Add hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
            this.style.boxShadow = 'var(--shadow-xl)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'var(--shadow-sm)';
        });
        
        grid.appendChild(card);
        
        // Render SUD chart
        setTimeout(() => {
            const chartElement = document.getElementById(`sud-chart-${idx}`);
            if (chartElement && p.sud_trend && p.sud_trend.length) {
                new Chart(chartElement, {
                    type: 'line',
                    data: {
                        labels: p.sud_trend.map((_, i) => i + 1),
                        datasets: [{
                            data: p.sud_trend,
                            borderColor: 'var(--primary-color)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false, min: 0, max: 10 }
                        }
                    }
                });
            }
        }, 0);
    });
}

function applyFilter() {
    let filtered = allPatients;
    
    if (currentFilter === 'flagged') {
        filtered = allPatients.filter(p => p.flagged);
    } else if (currentFilter === 'norecent') {
        filtered = allPatients.filter(p => p.last_session_days_ago !== null && p.last_session_days_ago > 14);
    } else if (currentFilter === 'highsud') {
        filtered = allPatients.filter(p => p.high_sud_trend);
    }
    
    renderGrid(filtered);
}

function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    
    if (filter === 'all') document.getElementById('filter-all').classList.add('active');
    if (filter === 'flagged') document.getElementById('filter-flagged').classList.add('active');
    if (filter === 'norecent') document.getElementById('filter-norecent').classList.add('active');
    if (filter === 'highsud') document.getElementById('filter-highsud').classList.add('active');
    
    applyFilter();
}

function showToast(msg) {
    const toast = document.getElementById('overview-toast');
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 2500);
}

function overviewDataChanged(newData, oldData) {
    return JSON.stringify(newData) !== JSON.stringify(oldData);
}

function fetchAndUpdateOverview(showToastOnChange = false) {
    fetch('/api/therapist/patients_overview')
        .then(r => r.json())
        .then(data => {
            if (!data.patients) data.patients = [];
            if (showToastOnChange && lastOverviewData && overviewDataChanged(data.patients, lastOverviewData)) {
                showToast('נתוני המטופלים עודכנו!');
            }
            allPatients = data.patients;
            lastOverviewData = JSON.parse(JSON.stringify(data.patients));
            renderAlerts(allPatients);
            applyFilter();
        })
        .catch(error => {
            console.error('Error fetching patient overview:', error);
            showToast('שגיאה בטעינת נתונים');
        });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Filter buttons
    document.getElementById('filter-all').addEventListener('click', () => setFilter('all'));
    document.getElementById('filter-flagged').addEventListener('click', () => setFilter('flagged'));
    document.getElementById('filter-norecent').addEventListener('click', () => setFilter('norecent'));
    document.getElementById('filter-highsud').addEventListener('click', () => setFilter('highsud'));
    
    // Initial load
    fetchAndUpdateOverview();
    
    // Auto-refresh every 30 seconds
    setInterval(() => fetchAndUpdateOverview(true), 30000);
});

// Add responsive styles
const responsiveStyles = `
    @media (max-width: 768px) {
        #patient-grid {
            grid-template-columns: 1fr !important;
            gap: var(--space-md) !important;
        }
        
        .btn-group {
            width: 100%;
            flex-direction: column;
        }
        
        .btn-group .btn {
            border-radius: var(--radius-md) !important;
            margin-bottom: var(--space-xs);
        }
    }
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = responsiveStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %} 