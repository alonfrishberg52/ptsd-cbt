{% extends 'dashboard/base_enhanced.html' %}

{% block title %}סיפורי חשיפה - NarraTIVE{% endblock %}
{% block page_title %}סיפורי חשיפה{% endblock %}
{% block page_description %}ניהול וביקורת סיפורים טיפוליים{% endblock %}

{% block content %}
<!-- Modern Dashboard Content -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">סיפורי חשיפה</h3>
            <p style="margin: var(--space-xs) 0 0; color: var(--text-secondary);">ניהול וביקורת סיפורים טיפוליים</p>
        </div>
        <i class="bi bi-journal-text" style="color: var(--primary-color); font-size: 2rem;"></i>
    </div>
    
    <div class="card-body" style="padding: var(--space-xl);">
        <!-- Filter Bar -->
        <div class="filter-bar" style="margin-bottom: var(--space-xl); display: flex; gap: var(--space-md); align-items: center; flex-wrap: wrap;">
            <span style="font-weight: 600; color: var(--text-secondary);">סנן:</span>
            <button class="btn btn-primary active" data-filter="all">הכל</button>
            <button class="btn btn-outline-danger" data-filter="fail">רק כשלונות</button>
            <button class="btn btn-outline-warning" data-filter="warn">רק אזהרות</button>
        </div>
        
        <!-- Stories Table -->
        <div style="overflow-x: auto; border-radius: var(--radius-lg); border: 1px solid rgba(0, 0, 0, 0.1);">
            <table class="table stories-table" style="margin: 0; background: white;">
                <thead style="background: var(--bg-subtle); border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
                        <tr>
                        <th style="padding: var(--space-lg); font-weight: 600; color: var(--text-primary);">Story ID</th>
                        <th style="padding: var(--space-lg); font-weight: 600; color: var(--text-primary);">תאריך</th>
                        <th style="padding: var(--space-lg); font-weight: 600; color: var(--text-primary);">מטופל</th>
                        <th style="padding: var(--space-lg); font-weight: 600; color: var(--text-primary);">חלק</th>
                        <th style="padding: var(--space-lg); font-weight: 600; color: var(--text-primary);">סטטוס</th>
                        <th style="padding: var(--space-lg); font-weight: 600; color: var(--text-primary);">פעולות</th>
                        </tr>
                    </thead>
        <tbody id="stories-tbody">
                        {% for story in stories %}
                    <tr data-patient="{{ story.patient_id }}" data-storyid="{{ story.story_id }}" style="border-bottom: 1px solid rgba(0, 0, 0, 0.05); transition: background var(--transition-fast);">
                        <td style="padding: var(--space-lg);">
                            <span class="badge badge-secondary">{{ story.short_id }}</span>
                        </td>
                        <td style="padding: var(--space-lg); color: var(--text-secondary);">
                            {{ story.timestamp }}
                        </td>
                        <td style="padding: var(--space-lg); font-weight: 500;">
                            {{ story.patient_id }}
                        </td>
                        <td style="padding: var(--space-lg);">
                            <span class="badge badge-info">{{ story.stage }}</span>
                        </td>
                        <td style="padding: var(--space-lg);">
                <div class="status-badge-wrap" id="status-badge-{{ story.story_id }}">
                                {% if story.status == 'approved' %}
                                <span class="badge badge-success"><i class="bi bi-check-circle"></i> מאושר</span>
                                {% elif story.status == 'rejected' %}
                                <span class="badge badge-danger"><i class="bi bi-x-circle"></i> נדחה</span>
                                {% elif story.status == 'regenerated' %}
                                <span class="badge badge-warning"><i class="bi bi-arrow-repeat"></i> נוצר מחדש</span>
                                {% else %}
                                <span class="badge badge-secondary"><i class="bi bi-hourglass-split"></i> ממתין</span>
                                {% endif %}
                </div>
            </td>
                        <td style="padding: var(--space-lg);">
                            <div class="action-btns" style="display: flex; gap: var(--space-sm); justify-content: center; align-items: center;">
                                <button type="button" class="btn btn-ghost btn-sm view-story-btn" data-bs-toggle="tooltip" title="הצג סיפור מלא" data-storyid="{{ story.story_id }}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-ghost btn-sm view-feedback-btn" data-bs-toggle="tooltip" title="הצג דוח בקרה" data-storyid="{{ story.story_id }}">
                                    <i class="bi bi-clipboard-check"></i>
                                </button>
                                <button type="button" class="btn btn-outline btn-sm regenerate-btn" data-bs-toggle="tooltip" title="צור מחדש" data-storyid="{{ story.story_id }}">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm reject-btn" data-bs-toggle="tooltip" title="דחה" data-storyid="{{ story.story_id }}">
                                    <i class="bi bi-x"></i>
                                </button>
                                <button type="button" class="btn btn-success btn-sm approve-btn" data-bs-toggle="tooltip" title="אשר" data-storyid="{{ story.story_id }}">
                                    <i class="bi bi-check"></i>
                                </button>
                            </div>
            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
</div>
</div>

<!-- Story Modal -->
<div class="modal fade" id="storyModal" tabindex="-1" aria-labelledby="storyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: var(--radius-lg); border: none; box-shadow: var(--shadow-xl);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding: var(--space-xl);">
                <h5 class="modal-title" id="storyModalLabel" style="font-weight: 700;">סיפור מלא</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
            <div class="modal-body" id="storyModalBody" style="padding: var(--space-xl);"></div>
    </div>
  </div>
</div>

<!-- Compliance Modal -->
<div class="modal fade" id="complianceModal" tabindex="-1" aria-labelledby="complianceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
        <div class="modal-content" style="border-radius: var(--radius-lg); border: none; box-shadow: var(--shadow-xl);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding: var(--space-xl);">
                <h5 class="modal-title" id="complianceModalLabel" style="font-weight: 700;">דוח כללים</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
            <div class="modal-body" id="complianceModalBody" style="padding: var(--space-xl);"></div>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog">
        <div class="modal-content" style="border-radius: var(--radius-lg); border: none; box-shadow: var(--shadow-xl);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding: var(--space-xl);">
                <h5 class="modal-title" id="feedbackModalLabel" style="font-weight: 700;">דוח בקרה מלא</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
            <div class="modal-body" id="feedbackModalBody" style="padding: var(--space-xl);"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const stories = {{ stories|tojson }};

    function setRowLoading(storyId, loading, text) {
        let row = document.querySelector(`tr[data-storyid='${storyId}']`);
        if (!row) {
            const btn = document.querySelector(`[data-storyid='${storyId}']`);
            if (btn) row = btn.closest('tr');
        }
        if (!row) return;
    
        let loader = row.querySelector('.row-loader');
        if (loading) {
            if (!loader) {
                loader = document.createElement('div');
                loader.className = 'row-loader';
            loader.style.cssText = `
                position: absolute; left: 0; top: 0; width: 100%; height: 100%; 
                background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; 
                justify-content: center; z-index: 2; border-radius: var(--radius-md);
            `;
            loader.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>${text || ''}</span>
                </div>
            `;
            row.style.position = 'relative';
                row.appendChild(loader);
            } else {
                loader.style.display = 'flex';
            loader.querySelector('span').textContent = text || '';
            }
            row.querySelectorAll('button').forEach(b => b.disabled = true);
        } else {
            if (loader) loader.style.display = 'none';
            row.querySelectorAll('button').forEach(b => b.disabled = false);
        }
    }

    function bindActionButtons() {
        document.querySelectorAll('.approve-btn').forEach(btn => {
            btn.onclick = function() {
                const storyId = this.dataset.storyid;
                setRowLoading(storyId, true, 'מאשר...');
            
                fetch('/api/story-action', {
                    method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'approve', story_id: storyId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    updateStatusBadge(storyId, 'approved');
                    if (window.dashboard) {
                        window.dashboard.showNotification('הסיפור אושר בהצלחה', 'success');
                    }
                } else {
                    throw new Error(data.message || 'שגיאה');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (window.dashboard) {
                    window.dashboard.showNotification('שגיאה באישור הסיפור', 'error');
                }
            })
            .finally(() => {
                    setRowLoading(storyId, false);
                });
            };
        });
    
        document.querySelectorAll('.reject-btn').forEach(btn => {
            btn.onclick = function() {
                const storyId = this.dataset.storyid;
                setRowLoading(storyId, true, 'דוחה...');
            
                fetch('/api/story-action', {
                    method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reject', story_id: storyId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    updateStatusBadge(storyId, 'rejected');
                    if (window.dashboard) {
                        window.dashboard.showNotification('הסיפור נדחה', 'warning');
                    }
                } else {
                    throw new Error(data.message || 'שגיאה');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (window.dashboard) {
                    window.dashboard.showNotification('שגיאה בדחיית הסיפור', 'error');
                }
            })
            .finally(() => {
                    setRowLoading(storyId, false);
                });
            };
        });
    
        document.querySelectorAll('.regenerate-btn').forEach(btn => {
            btn.onclick = function() {
                const storyId = this.dataset.storyid;
            setRowLoading(storyId, true, 'יוצר מחדש...');
            
                fetch('/api/story-action', {
                    method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'regenerate', story_id: storyId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    updateStatusBadge(storyId, 'regenerated');
                    if (window.dashboard) {
                        window.dashboard.showNotification('הסיפור נוצר מחדש', 'info');
                    }
                } else {
                    throw new Error(data.message || 'שגיאה');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (window.dashboard) {
                    window.dashboard.showNotification('שגיאה ביצירת הסיפור מחדש', 'error');
                }
            })
            .finally(() => {
                    setRowLoading(storyId, false);
                });
            };
        });
    
    document.querySelectorAll('.view-story-btn').forEach(btn => {
        btn.onclick = function() {
            const storyId = this.dataset.storyid;
            const story = stories.find(s => s.story_id === storyId);
            if (story && story.result && story.result.story) {
                document.getElementById('storyModalBody').innerHTML = `
                    <div style="white-space: pre-wrap; line-height: 1.6; font-size: 1rem;">
                        ${story.result.story}
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('storyModal')).show();
            }
        };
    });
    
    document.querySelectorAll('.view-feedback-btn').forEach(btn => {
        btn.onclick = function() {
            const storyId = this.dataset.storyid;
            const story = stories.find(s => s.story_id === storyId);
            if (story) {
                let feedbackHtml = '<div class="feedback-report">';
                
                if (story.compliance) {
                    feedbackHtml += `<h6 style="color: var(--primary-color); margin-bottom: var(--space-md);">דוח תאימות:</h6>`;
                    feedbackHtml += `<p style="margin-bottom: var(--space-lg);">${story.compliance.summary || 'אין מידע זמין'}</p>`;
                }
                
                feedbackHtml += '<h6 style="color: var(--primary-color); margin-bottom: var(--space-md);">פרטי ביקורת:</h6>';
                feedbackHtml += `<p><strong>משוב נרטיבי:</strong> ${story.narrative_feedback || 'אין'}</p>`;
                feedbackHtml += `<p><strong>משוב דיאלוג:</strong> ${story.dialogue_feedback || 'אין'}</p>`;
                feedbackHtml += `<p><strong>משוב כללים:</strong> ${story.rule_feedback || 'אין'}</p>`;
                feedbackHtml += `<p><strong>משוב עברית:</strong> ${story.hebrew_feedback || 'אין'}</p>`;
                
                feedbackHtml += '</div>';
                
                document.getElementById('feedbackModalBody').innerHTML = feedbackHtml;
                new bootstrap.Modal(document.getElementById('feedbackModal')).show();
            }
        };
    });
}

function updateStatusBadge(storyId, newStatus) {
    const badge = document.getElementById(`status-badge-${storyId}`);
    if (!badge) return;
    
    let badgeHTML = '';
    switch (newStatus) {
        case 'approved':
            badgeHTML = '<span class="badge badge-success"><i class="bi bi-check-circle"></i> מאושר</span>';
            break;
        case 'rejected':
            badgeHTML = '<span class="badge badge-danger"><i class="bi bi-x-circle"></i> נדחה</span>';
            break;
        case 'regenerated':
            badgeHTML = '<span class="badge badge-warning"><i class="bi bi-arrow-repeat"></i> נוצר מחדש</span>';
            break;
        default:
            badgeHTML = '<span class="badge badge-secondary"><i class="bi bi-hourglass-split"></i> ממתין</span>';
    }
    
    badge.innerHTML = badgeHTML;
    }

// Filter functionality
function filterStories(filterType) {
            const rows = Array.from(document.querySelectorAll('#stories-tbody tr'));
    
            rows.forEach(row => {
                let show = true;
        
        if (filterType === 'fail') {
            const badge = row.querySelector('.badge-danger');
            show = badge !== null;
        } else if (filterType === 'warn') {
            const badge = row.querySelector('.badge-warning');
            show = badge !== null;
        }
        
                row.style.display = show ? '' : 'none';
            });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
            bindActionButtons();
    
    // Filter buttons
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filterType = this.dataset.filter;
            filterStories(filterType);
        });
    });
    
    // Add hover effects to table rows
    document.querySelectorAll('#stories-tbody tr').forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(37, 99, 235, 0.05)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
        });
    });
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Add enhanced styles
const enhancedStyles = `
    .stories-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .action-btns .btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all var(--transition-fast);
    }
    
    .action-btns .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .filter-bar .btn {
        border-radius: var(--radius-full);
        padding: var(--space-sm) var(--space-lg);
        font-weight: 500;
        transition: all var(--transition-fast);
    }
    
    .filter-bar .btn:hover {
        transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
        .stories-table th,
        .stories-table td {
            padding: var(--space-md) var(--space-sm) !important;
            font-size: 0.9rem;
        }
        
        .action-btns {
            flex-direction: column !important;
            gap: var(--space-xs) !important;
        }
        
        .action-btns .btn {
            width: 32px;
            height: 32px;
        }
        
        .filter-bar {
            flex-direction: column !important;
            align-items: stretch !important;
        }
        
        .filter-bar .btn {
            margin-bottom: var(--space-xs);
        }
    }
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = enhancedStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %} 